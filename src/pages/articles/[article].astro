---
import Layout from '../../layouts/Layout.astro';
import Footer from '../../components/Footer.astro';
import Prose from '../../layouts/Prose.astro';
import { getImage } from 'astro:assets';
import heroImg from '../../assets/hero.jpg';

export function getStaticPaths() {
	const allPosts = Object.values(import.meta.glob('../../data/articles/*.md', { eager: true })) as any[];
	return allPosts.map((post) => {
		const { file, frontmatter, Content } = post;
		const articleSlug = frontmatter.slug || file.split('/').pop().replace('.md', '');

		return {
			params: { article: articleSlug },
			props: { frontmatter, Content },
		};
	});
}

const rawPosts = Object.values(import.meta.glob('../../data/articles/*.md', { eager: true })) as any[];
const allPosts = rawPosts.map((post) => {
	const { file, frontmatter } = post;
	const articleSlug = frontmatter.slug || file.split('/').pop().replace('.md', '');
	return {
		title: frontmatter.title,
		description: frontmatter.description,
		link: `/articles/${articleSlug}`,
		date: frontmatter.date,
		draft: frontmatter.draft || false,
	}
});

const filteredPosts = allPosts.filter(post => !post.draft);
const sortedPosts = filteredPosts.sort((a, b) => new Date(b.date).getTime() - new Date(a.date).getTime());

const { frontmatter, Content } = Astro.props;

// Resolve thumbnail image
const images = import.meta.glob('../../assets/**/*.{jpeg,jpg,png,webp}', { eager: true }) as Record<string, any>;
let thumbnailSrc = heroImg;

if (frontmatter.thumbnail) {
	const imagePath = `../../assets${frontmatter.thumbnail}`;
	if (images[imagePath]) {
		thumbnailSrc = images[imagePath].default;
	}
}

const optimizedBackground = await getImage({src: thumbnailSrc, format: 'webp'});
---
<Layout 
	title={frontmatter.title} 
	description={frontmatter.description}
	robots={frontmatter.draft ? "noindex, nofollow" : "index, follow"}
>
	<main>
		<div
			class="relative w-full bg-cover bg-center pt-48 pb-24"
			style={{ backgroundImage: `url(${optimizedBackground.src})` }}
		>
			<div class="absolute inset-0 bg-black/70"></div>
				
			<div class="relative container mx-auto px-4 flex flex-col text-white items-start justify-center gap-2 text-left">
				<h1 class="text-4xl md:text-5xl !text-white font-extrabold leading-tight" style="text-shadow: 0 2px 4px rgba(0,0,0,0.5);">{frontmatter.title}</h1>
				<div class="bg-primary/80 text-white px-4 py-2 my-4 text-sm rounded-full">
					Oleh: {frontmatter.author} &middot; {new Date(frontmatter.date).toLocaleDateString('id-ID', { day: 'numeric', month: 'long', year: 'numeric' })}
				</div>
			</div>
		</div>

		<div class="container mx-auto flex md:flex-row flex-col gap-8 md:gap-12 p-4 md:p-8 lg:p-12">
				
			<article class="w-full md:w-3/4">
				<Prose>
					<Content/>
				</Prose>
			</article>

			<aside class="w-full md:w-1/4 md:sticky md:top-28 h-fit bg-white p-6 rounded-2xl shadow-lg">
				<h2 class="text-2xl mb-4 border-b-2 border-primary pb-2">Artikel Lainnya</h2>
				<ul class="flex flex-col gap-4">
					{sortedPosts.slice(0, 5).map((post) => (
						<li>
							<a href={post.link} class="block p-4 rounded-lg hover:bg-gray-100 transition-colors">
								<h3 class="font-semibold !text-gray-800">{post.title}</h3>
								<p class="text-sm text-gray-500 line-clamp-2">{post.description}</p>
							</a>
						</li>
					))}
				</ul>
				<a href="/articles" class="btn w-full text-center mt-6 bg-primary">
						Lihat Semua
				</a>
			</aside>
		</div>
	</main>
	<Footer/>
</Layout>

